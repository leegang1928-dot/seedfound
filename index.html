<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>범인을 찾아라</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+KR:wght@400;600&display=swap">

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    min-height: 100vh;
    background:
        linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)),
        url("pexels-cottonbro-7319084.jpg");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    font-family: "Noto Serif KR", serif;
    color: #f5f2ec;
}

/* 화면 */
.screen {
    display: none;
    min-height: 100vh;
    padding: 24px;
}
.screen.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 카드 */
.container {
    width: 100%;
    max-width: 420px;
    background: rgba(20,17,14,0.85);
    border-radius: 16px;
    padding: 28px 22px;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 제목 */
h1 {
    font-family: "Cinzel", serif;
    text-align: center;
    font-size: 40px;
    margin-bottom: 32px;
}

/* 버튼 */
.tabs {
    display: flex;
    flex-direction: column;
    gap: 14px;
}
.tab {
    padding: 16px;
    border-radius: 12px;
    background: #1b1712;
    border: 1px solid #555;
    text-align: center;
    cursor: pointer;
}
.tab:hover {
    border-color: #c9a46a;
}

/* 상단 */
.top-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;
}
.back {
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #1b1712;
    cursor: pointer;
}

/* 단서 수집 */
.clue-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.clue {
    height: 100px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    border: 1px dashed #777;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
}

.clue.locked {
    opacity: 0.4;
    cursor: not-allowed;
    background: rgba(255,255,255,0.03);
}

.clue.active {
    opacity: 1;
    cursor: pointer;
    border: 1px solid #c9a46a;
}

/* 용의자 */
.profile-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.profile {
    padding: 16px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    border: 1px solid #666;
    cursor: pointer;
}
.profile:hover {
    border-color: #c9a46a;
}

/* 확인 팝업 */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
}
.modal.active {
    display: flex;
}
.modal-box {
    background: #1b1712;
    padding: 24px;
    border-radius: 14px;
    width: 90%;
    max-width: 320px;
    text-align: center;
}
.modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}
.modal-buttons button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #2a241c;
    color: #fff;
    cursor: pointer;
}

/* 결과 */
.result {
    text-align: center;
    font-size: 20px;
    line-height: 1.6;
}

/* 관리자 조 목록 스크롤 */
#admin .profile-list {
    max-height: 360px;      /* 원하는 높이 (조절 가능) */
    overflow-y: auto;
    padding-right: 4px;
}

/* 스크롤바 예쁘게 (선택) */
#admin .profile-list::-webkit-scrollbar {
    width: 6px;
}
#admin .profile-list::-webkit-scrollbar-thumb {
    background: rgba(201,164,106,0.6);
    border-radius: 4px;
}
#admin .profile-list::-webkit-scrollbar-track {
    background: transparent;
}

#admin .container {
    max-height: 90vh;
    overflow-y: auto;
}

#adminClues .clue {
    cursor: pointer;
}

</style>
</head>

<body>

<!-- 로그인 -->
<div id="login" class="screen active">
    <div class="container">
        <h1>범인을 찾아라</h1>

        <div style="display:flex; flex-direction:column; gap:12px;">
            <input id="username" placeholder="이름"
                style="padding:12px; border-radius:8px; border:none;">

            <input id="code" placeholder="참여 코드"
                style="padding:12px; border-radius:8px; border:none;">

            <div class="tab" onclick="checkLogin()">입장하기</div>
        </div>
    </div>
</div>

<!-- 관리자 화면 -->
<div id="admin" class="screen">
    <div class="container">

        <!-- 관리자 상단바 (처음엔 숨김) -->
        <div id="adminTopBar" class="top-bar" style="display:none; justify-content:space-between;">
            <div id="adminTitle"></div>
            <div class="back" onclick="closeAdminPlayer()">뒤로가기</div>
        </div>

        <h1 id="adminMainTitle">관리자 메뉴</h1>

        <!-- 조 목록 -->
        <div id="adminList" class="profile-list">
            <div class="profile" onclick="openAdminPlayer('1조')">1조</div>
            <div class="profile" onclick="openAdminPlayer('2조')">2조</div>
            <div class="profile" onclick="openAdminPlayer('3조')">3조</div>
            <div class="profile" onclick="openAdminPlayer('4조')">4조</div>
            <div class="profile" onclick="openAdminPlayer('5조')">5조</div>
            <div class="profile" onclick="openAdminPlayer('6조')">6조</div>
            <div class="profile" onclick="openAdminPlayer('7조')">7조</div>
            <div class="profile" onclick="openAdminPlayer('8조')">8조</div>
            <div class="profile" onclick="openAdminPlayer('9조')">9조</div>
            <div class="profile" onclick="openAdminPlayer('10조')">10조</div>
            <div class="profile" onclick="openAdminPlayer('11조')">11조</div>
            <div class="profile" onclick="openAdminPlayer('12조')">12조</div>
        </div>

        <!-- 단서 관리 -->
        <div id="adminClues" style="margin-top:20px; display:none;">
            <div class="clue-grid">
                <div class="clue locked" onclick="toggleClue(1)">단서 1</div>
                <div class="clue locked" onclick="toggleClue(2)">단서 2</div>
                <div class="clue locked" onclick="toggleClue(3)">단서 3</div>
                <div class="clue locked" onclick="toggleClue(4)">단서 4</div>
                <div class="clue locked" onclick="toggleClue(5)">단서 5</div>
                <div class="clue locked" onclick="toggleClue(6)">단서 6</div>
            </div>
        </div>
    </div>
</div>

<!-- 메인 -->
<div id="main" class="screen">
    <div class="container">
        <h1>범인을 찾아라</h1>
        <div class="tabs">
            <div class="tab" onclick="loadPlayerClues(); showScreen('clue')">단서 수집</div>
            <div class="tab" onclick="showScreen('suspect')">용의자 탐색</div>
        </div>
    </div>
</div>

<!-- ===== 단서 수집 ===== -->
<div id="clue" class="screen">
    <div class="container">
        <div class="top-bar">
            <div class="back" onclick="showScreen('main')">뒤로가기</div>
        </div>

        <div class="clue-grid">
            <div class="clue locked" data-id="1" onclick="openClue(1)">단서 1</div>
            <div class="clue locked" data-id="2" onclick="openClue(2)">단서 2</div>
            <div class="clue locked" data-id="3" onclick="openClue(3)">단서 3</div>
            <div class="clue locked" data-id="4" onclick="openClue(4)">단서 4</div>
            <div class="clue locked" data-id="5" onclick="openClue(5)">단서 5</div>
            <div class="clue locked" data-id="6" onclick="openClue(6)">단서 6</div>
        </div>
    </div>
</div>

<!-- 용의자 -->
<div id="suspect" class="screen">
    <div class="container">
        <div class="top-bar">
            <div class="back" onclick="showScreen('main')">뒤로가기</div>
        </div>

        <div class="profile-list">
            <div class="profile" onclick="selectSuspect('일강')">일강</div>
            <div class="profile" onclick="selectSuspect('이강')">이강</div>
            <div class="profile" onclick="selectSuspect('삼강')">삼강</div>
            <div class="profile" onclick="selectSuspect('사강')">사강</div>
            <div class="profile" onclick="selectSuspect('오강')">오강</div>
            <div class="profile" onclick="selectSuspect('육강')">육강</div>
        </div>
    </div>
</div>

<!-- 결과 -->
<div id="result" class="screen">
    <div class="container">
        <div class="result" id="resultText"></div>
        <div class="tabs" style="margin-top:24px">
            <div class="tab" onclick="showScreen('main')">처음으로</div>
        </div>
    </div>
</div>

<!-- 확인 팝업 -->
<div id="modal" class="modal">
    <div class="modal-box">
        <div>선택을 확신 하십니까?</div>
        <div class="modal-buttons">
            <button onclick="confirmChoice()">예</button>
            <button onclick="closeModal()">아니요</button>
        </div>
    </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxwc51HzmqeXbVg15MYleaO0e6-hI6AenqbBxpwE278QyjhTbIpa5jmL6jBa1AWfMzeTw/exec";
let currentUser = "";
/* 단서 활성화 상태 */
const clueState = {
    1: false,
    2: false,
    3: false,
    4: false,
    5: false,
    6: false
};

/* 단서 내용 */
const clueContent = {
    1: "단서 1: 사건 발생 시간은 밤 11시였다.",
    2: "단서 2: 현장에서 깨진 시계가 발견되었다.",
    3: "단서 3: 범인은 왼손잡이일 가능성이 높다.",
    4: "단서 4: 용의자 중 한 명은 알리바이가 거짓이다.",
    5: "단서 5: 범행 도구는 방 안에 있었다.",
    6: "단서 6: 범인은 피해자와 아는 사이였다."
};

/* 단서 클릭 */
function openClue(num) {
    if (!clueState[num]) return;
    alert(clueContent[num]);
}

/* 단서 활성화 (나중에 관리자용으로 사용 가능) */
function activateClue(num) {
    clueState[num] = true;
    const clue = document.querySelector(`.clue[data-id="${num}"]`);
    clue.classList.remove("locked");
    clue.classList.add("active");
}

let chosen = "";

let selectedPlayer = "";

function openAdminPlayer(name) {
    selectedPlayer = name;

    // 제목 / 상단바 전환
    document.getElementById("adminMainTitle").style.display = "none";
    document.getElementById("adminList").style.display = "none";
    document.getElementById("adminTopBar").style.display = "flex";

    document.getElementById("adminTitle").innerText = name;

    document.getElementById("adminClues").style.display = "block";
    renderAdminClues();
}

function closeAdminPlayer() {
    selectedPlayer = "";

    document.getElementById("adminTopBar").style.display = "none";
    document.getElementById("adminClues").style.display = "none";

    document.getElementById("adminMainTitle").style.display = "block";
    document.getElementById("adminList").style.display = "flex";
}

async function toggleClue(num) {
  if (!selectedPlayer) return;

  const isActive =
    document.querySelectorAll("#adminClues .clue")[num - 1]
      .classList.contains("active");

  const url =
    `${GAS_URL}?team=${encodeURIComponent(selectedPlayer)}` +
    `&clue=${num}&value=${!isActive}`;

  await fetch(url);
  await renderAdminClues();
}

async function renderAdminClues() {
    if (!selectedPlayer) return;

    try {
        const res = await fetch(`${GAS_URL}?team=${selectedPlayer}`);
        const text = await res.text();       // 항상 텍스트로 받기
        const data = JSON.parse(text);       // JSON으로 파싱

        const clues = document.querySelectorAll("#adminClues .clue");
        clues.forEach((clue, idx) => {
            clue.classList.remove("active", "locked");

            const val = data[`clue${idx + 1}`];
            const isActive = (val === true || val === "TRUE" || val === "true");

            if (isActive) clue.classList.add("active");
            else clue.classList.add("locked");
        });
    } catch (err) {
        console.error("관리자 단서 불러오기 실패:", err, err.stack);
    }
}

async function loadPlayerClues() {
    if (currentUser === "관리자") return;

    try {
        const res = await fetch(`${GAS_URL}?team=${currentUser}`);
        const text = await res.text();      // 무조건 text로 받기
        const data = JSON.parse(text);      // JSON으로 파싱

        const clues = document.querySelectorAll("#clue .clue");
        clues.forEach((clue, idx) => {
            clue.classList.remove("active", "locked");

            const val = data[`clue${idx + 1}`];
            const isActive = (val === true || val === "TRUE" || val === "true");

            clueState[idx + 1] = isActive;

            if (isActive) clue.classList.add("active");
            else clue.classList.add("locked");
        });
    } catch (err) {
        console.error("플레이어 단서 불러오기 실패:", err, err.stack);
    }
}

// 플레이어 화면에서 2초마다 서버 데이터 갱신
setInterval(async () => {
    if (currentUser !== "관리자" && document.getElementById("clue").classList.contains("active")) {
        await loadPlayerClues();
    }
}, 1000);

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === "clue") {
        loadPlayerClues();
    }
}

function selectSuspect(name) {
    chosen = name;
    document.getElementById("modal").classList.add("active");
}

function closeModal() {
    document.getElementById("modal").classList.remove("active");
}

function confirmChoice() {
    closeModal();
    let text = "";
    if (chosen === "이강") {
        text = "이강은 범인이 맞습니다.";
    } else {
        text = `${chosen}은 범인이 아니였습니다.`;
    }
    document.getElementById("resultText").innerText = text;
    showScreen("result");
}

async function checkLogin() {
    const name = document.getElementById("username").value;
    const code = document.getElementById("code").value;

    // ✅ 허용할 이름 + 참여코드 (원하는 대로 추가 가능)
    const validUsers = {
        "관리자": "1928",
        "1조": "5436",
        "2조": "3472",
        "3조": "9375",
        "4조": "5736",
        "5조": "3062",
        "6조": "9312",
        "7조": "5463",
        "8조": "3028",
        "9조": "9003",
        "10조": "0193",
        "11조": "3424",
        "12조": "9336"
    };

    if (validUsers[name] && validUsers[name] === code) {
        currentUser = name;
        isAdmin = (name === "관리자");

        if (isAdmin) {
            showScreen("admin");
        } else {
            showScreen("main");
            await loadPlayerClues();
        }
    } else {
        alert("정보가 일치하지 않습니다");
    }
}
</script>

</body>
</html>
